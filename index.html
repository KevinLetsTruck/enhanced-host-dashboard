<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Host Dashboard - AudioRoad</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const EnhancedHostDashboard = () => {
            const [callerQueue, setCallerQueue] = useState([]);
            const [activeCallers, setActiveCallers] = useState([]);
            const [audioChannels, setAudioChannels] = useState({});
            const [masterVolume, setMasterVolume] = useState(85);
            const [isLive, setIsLive] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [lastSync, setLastSync] = useState('');
            const [showAudio, setShowAudio] = useState({ currentTrack: null, volume: 75 });

            // Initialize 10-channel audio mixer
            const channelSetup = [
                { id: 'host', label: 'Host Mic', type: 'host' },
                { id: 'guest1', label: 'Guest 1', type: 'guest' },
                { id: 'guest2', label: 'Guest 2', type: 'guest' },
                { id: 'guest3', label: 'Guest 3', type: 'guest' },
                { id: 'caller1', label: 'Caller 1', type: 'caller' },
                { id: 'caller2', label: 'Caller 2', type: 'caller' },
                { id: 'caller3', label: 'Caller 3', type: 'caller' },
                { id: 'caller4', label: 'Caller 4', type: 'caller' },
                { id: 'caller5', label: 'Caller 5', type: 'caller' },
                { id: 'computer', label: 'Computer Audio', type: 'computer' }
            ];

            const audioLibrary = [
                { id: 1, name: 'Show Open - Trucking Business & Beyond', type: 'open', duration: '0:45' },
                { id: 2, name: 'Show Close - Thank You', type: 'close', duration: '0:30' },
                { id: 3, name: 'Commercial Break Intro', type: 'transition', duration: '0:15' },
                { id: 4, name: 'Sponsor - AudioRoad', type: 'commercial', duration: '1:00' },
                { id: 5, name: 'Health Segment Intro', type: 'segment', duration: '0:12' }
            ];

            useEffect(() => {
                // Initialize audio channels
                const initialChannels = {};
                channelSetup.forEach(channel => {
                    initialChannels[channel.id] = {
                        volume: channel.id === 'host' ? 85 : 65,
                        muted: false,
                        connected: channel.id === 'host',
                        currentLevel: 0
                    };
                });
                setAudioChannels(initialChannels);

                // Initialize WebRTC connection
                fetch('http://api.audioroad-live.com:8080/health')
                    .then(response => {
                        if (response.ok) {
                            setConnectionStatus('connected');
                            return response.json();
                        } else {
                            setConnectionStatus('error');
                        }
                    })
                    .then(data => console.log('WebRTC server connected:', data))
                    .catch(error => {
                        console.error('Connection failed:', error);
                        setConnectionStatus('error');
                    });

                fetchReadyCallers();
                const syncInterval = setInterval(fetchReadyCallers, 10000);
                const levelInterval = setInterval(updateAudioLevels, 200);
                
                return () => {
                    clearInterval(syncInterval);
                    clearInterval(levelInterval);
                };
            }, []);

            const fetchReadyCallers = async () => {
                try {
                    const response = await fetch('http://api.audioroad-live.com:8080/api/callers');
                    if (response.ok) {
                        const data = await response.json();
                        setCallerQueue(data);
                        setLastSync(new Date().toLocaleTimeString());
                    }
                } catch (error) {
                    console.error('Failed to fetch callers:', error);
                }
            };

            const updateAudioLevels = () => {
                setAudioChannels(prev => {
                    const updated = { ...prev };
                    Object.keys(updated).forEach(channelId => {
                        if (updated[channelId].connected && !updated[channelId].muted) {
                            updated[channelId].currentLevel = Math.random() * 80 + 10;
                        } else {
                            updated[channelId].currentLevel = 0;
                        }
                    });
                    return updated;
                });
            };

            const takeCallerLive = (caller) => {
                const availableChannel = channelSetup.find(ch => 
                    ch.type === 'caller' && !audioChannels[ch.id].connected
                );
                
                if (availableChannel) {
                    setAudioChannels(prev => ({
                        ...prev,
                        [availableChannel.id]: { ...prev[availableChannel.id], connected: true }
                    }));
                    
                    setActiveCallers(prev => [...prev, {
                        ...caller,
                        channelId: availableChannel.id,
                        liveTime: new Date()
                    }]);
                    
                    setCallerQueue(prev => prev.filter(c => c.id !== caller.id));
                    alert(`${caller.name} is now live on ${availableChannel.label}!`);
                } else {
                    alert('No available caller channels. End a call first.');
                }
            };

            const endCall = (callerId) => {
                const caller = activeCallers.find(c => c.id === callerId);
                if (caller) {
                    setAudioChannels(prev => ({
                        ...prev,
                        [caller.channelId]: { ...prev[caller.channelId], connected: false }
                    }));
                    setActiveCallers(prev => prev.filter(c => c.id !== callerId));
                    alert(`Call with ${caller.name} ended`);
                }
            };

            const updateChannelVolume = (channelId, volume) => {
                setAudioChannels(prev => ({
                    ...prev,
                    [channelId]: { ...prev[channelId], volume: parseInt(volume) }
                }));
            };

            const toggleChannelMute = (channelId) => {
                setAudioChannels(prev => ({
                    ...prev,
                    [channelId]: { ...prev[channelId], muted: !prev[channelId].muted }
                }));
            };

            const playAudioClip = (clip) => {
                setShowAudio(prev => ({ ...prev, currentTrack: clip }));
                alert(`Playing: ${clip.name}`);
            };

            const AudioChannel = ({ channel }) => {
                const channelData = audioChannels[channel.id];
                if (!channelData) return null;

                const isActive = channelData.connected;
                const level = channelData.currentLevel || 0;

                return (
                    <div className={`p-3 border rounded-lg ${isActive ? 'bg-green-50 border-green-200' : 'bg-gray-50'}`}>
                        <div className="text-xs font-medium mb-2 flex justify-between">
                            <span>{channel.label}</span>
                            {isActive && <span className="text-green-600 text-xs">LIVE</span>}
                        </div>
                        
                        {isActive && (
                            <div className="space-y-2">
                                {/* Audio Level Meter */}
                                <div className="h-2 bg-gray-200 rounded overflow-hidden">
                                    <div 
                                        className={`h-full transition-all duration-100 ${
                                            level > 80 ? 'bg-red-500' : level > 60 ? 'bg-yellow-500' : 'bg-green-500'
                                        }`}
                                        style={{ width: `${level}%` }}
                                    />
                                </div>
                                
                                {/* Volume Control */}
                                <div className="flex items-center gap-1">
                                    <span className="text-xs">Vol:</span>
                                    <input
                                        type="range"
                                        min="0"
                                        max="150"
                                        value={channelData.volume}
                                        onChange={(e) => updateChannelVolume(channel.id, e.target.value)}
                                        className="flex-1"
                                    />
                                    <span className="text-xs w-8">{channelData.volume}%</span>
                                </div>
                                
                                {/* Controls */}
                                <div className="flex gap-1">
                                    <button
                                        onClick={() => toggleChannelMute(channel.id)}
                                        className={`px-2 py-1 text-xs rounded ${channelData.muted ? 'bg-red-600 text-white' : 'bg-gray-200'}`}
                                    >
                                        {channelData.muted ? 'üîá' : 'üîä'}
                                    </button>
                                    
                                    {channel.type === 'caller' && (
                                        <button
                                            onClick={() => {
                                                const activeCaller = activeCallers.find(c => c.channelId === channel.id);
                                                if (activeCaller) endCall(activeCaller.id);
                                            }}
                                            className="px-2 py-1 text-xs bg-red-600 text-white rounded"
                                        >
                                            üìû
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {!isActive && (
                            <div className="text-center py-4 text-gray-400">
                                <p className="text-xs">Not Connected</p>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gray-900 text-white p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h1 className="text-3xl font-bold flex items-center gap-2">
                                    üìª Enhanced Host Dashboard
                                </h1>
                                <p className="text-gray-300">Professional Broadcast Control System</p>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <div className={`w-3 h-3 rounded-full ${connectionStatus === 'connected' ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                    <span className="text-sm">{connectionStatus}</span>
                                </div>
                                
                                <div className={`flex items-center gap-2 px-3 py-1 rounded ${
                                    isLive ? 'bg-red-600 text-white' : 'bg-gray-700'
                                }`}>
                                    <div className={`w-3 h-3 rounded-full ${isLive ? 'bg-white animate-pulse' : 'bg-gray-400'}`}></div>
                                    <span className="font-medium">{isLive ? 'ON AIR' : 'OFF AIR'}</span>
                                </div>
                                
                                <button
                                    onClick={() => setIsLive(!isLive)}
                                    className={`px-4 py-2 rounded font-medium ${isLive ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}
                                >
                                    üìª {isLive ? 'Go Off Air' : 'Go Live'}
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 xl:grid-cols-4 gap-6">
                            {/* Caller Queue */}
                            <div className="xl:col-span-1">
                                <div className="bg-gray-800 p-6 rounded-lg">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-bold">Ready Callers ({callerQueue.length})</h2>
                                        <button 
                                            onClick={fetchReadyCallers}
                                            className="px-3 py-1 bg-gray-700 rounded text-sm hover:bg-gray-600"
                                        >
                                            üîÑ Refresh
                                        </button>
                                    </div>
                                    
                                    {callerQueue.length === 0 ? (
                                        <div className="text-center py-8">
                                            <p className="text-gray-400 mb-2">No callers ready</p>
                                            <p className="text-sm text-gray-500">Waiting for screener to send callers</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {callerQueue.map(caller => (
                                                <div key={caller.id} className={`p-4 rounded-lg ${caller.priority === 'high' ? 'bg-red-900 border border-red-500' : 'bg-gray-700'}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <h3 className="font-bold">{caller.name}</h3>
                                                            <p className="text-sm text-gray-300">{caller.phone}</p>
                                                            {caller.priority === 'high' && (
                                                                <div className="flex items-center gap-1 text-red-400 text-sm">
                                                                    ‚ö†Ô∏è CRITICAL PRIORITY
                                                                </div>
                                                            )}
                                                        </div>
                                                        <span className={`px-2 py-1 rounded text-xs ${caller.priority === 'high' ? 'bg-red-600' : 'bg-gray-600'}`}>
                                                            {caller.priority}
                                                        </span>
                                                    </div>
                                                    
                                                    <p className="text-sm mb-2"><strong>Topic:</strong> {caller.topic}</p>
                                                    {caller.notes && <p className="text-sm mb-2"><strong>Notes:</strong> {caller.notes}</p>}
                                                    
                                                    <button 
                                                        onClick={() => takeCallerLive(caller)}
                                                        className={`w-full mt-3 py-2 rounded font-medium ${caller.priority === 'high' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}
                                                    >
                                                        üìû Take Live
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Audio Mixer */}
                            <div className="xl:col-span-2">
                                <div className="bg-gray-800 p-6 rounded-lg">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold">üéöÔ∏è 10-Channel Audio Mixer</h2>
                                        <button
                                            onClick={() => setIsRecording(!isRecording)}
                                            className={`px-4 py-2 rounded font-medium ${isRecording ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}
                                        >
                                            {isRecording ? '‚èπÔ∏è Stop Recording' : '‚è∫Ô∏è Start Recording'}
                                        </button>
                                    </div>

                                    {/* Master Volume */}
                                    <div className="mb-6 p-4 bg-gray-700 rounded-lg">
                                        <div className="flex items-center gap-4">
                                            <span className="text-sm text-white">Master Volume:</span>
                                            <input
                                                type="range"
                                                min="0"
                                                max="100"
                                                value={masterVolume}
                                                onChange={(e) => setMasterVolume(e.target.value)}
                                                className="flex-1"
                                            />
                                            <span className="text-sm w-12 text-white">{masterVolume}%</span>
                                        </div>
                                    </div>

                                    {/* Audio Channels */}
                                    <div className="grid grid-cols-2 lg:grid-cols-3 gap-4">
                                        {channelSetup.map(channel => (
                                            <AudioChannel key={channel.id} channel={channel} />
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Show Audio & Status */}
                            <div className="xl:col-span-1 space-y-6">
                                {/* Show Audio */}
                                <div className="bg-gray-800 p-6 rounded-lg">
                                    <h2 className="text-xl font-bold mb-4">üéµ Show Audio</h2>
                                    
                                    {showAudio.currentTrack && (
                                        <div className="p-3 bg-blue-900 rounded mb-4">
                                            <p className="text-sm font-medium text-blue-100 mb-2">
                                                {showAudio.currentTrack.name}
                                            </p>
                                            <button 
                                                onClick={() => setShowAudio(prev => ({ ...prev, currentTrack: null }))}
                                                className="px-3 py-1 bg-red-600 rounded text-sm"
                                            >
                                                ‚èπÔ∏è Stop
                                            </button>
                                        </div>
                                    )}

                                    <div className="space-y-2 max-h-64 overflow-y-auto">
                                        {audioLibrary.map(clip => (
                                            <div key={clip.id} className="flex items-center justify-between p-2 bg-gray-700 rounded">
                                                <div>
                                                    <p className="text-sm font-medium">{clip.name}</p>
                                                    <div className="flex gap-2">
                                                        <span className="text-xs bg-gray-600 px-2 py-1 rounded">{clip.type}</span>
                                                        <span className="text-xs text-gray-400">{clip.duration}</span>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => playAudioClip(clip)}
                                                    className="px-2 py-1 bg-blue-600 rounded text-sm hover:bg-blue-700"
                                                >
                                                    ‚ñ∂Ô∏è
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Active Callers */}
                                {activeCallers.length > 0 && (
                                    <div className="bg-gray-800 p-6 rounded-lg">
                                        <h2 className="text-xl font-bold mb-4">üìû Live Callers ({activeCallers.length})</h2>
                                        {activeCallers.map(caller => (
                                            <div key={caller.id} className="mb-3 p-3 bg-green-900 rounded">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <h4 className="font-bold text-green-100">{caller.name}</h4>
                                                        <p className="text-sm text-green-200">{caller.topic}</p>
                                                    </div>
                                                    <span className="text-xs bg-green-600 px-2 py-1 rounded">LIVE</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-xs text-green-300">
                                                        On air: {Math.floor((new Date() - caller.liveTime) / 1000)}s
                                                    </span>
                                                    <button
                                                        onClick={() => endCall(caller.id)}
                                                        className="px-3 py-1 bg-red-600 rounded text-sm hover:bg-red-700"
                                                    >
                                                        üìû End Call
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* System Status */}
                                <div className="bg-gray-800 p-6 rounded-lg">
                                    <h2 className="text-xl font-bold mb-4">‚úÖ System Status</h2>
                                    <div className="space-y-2 text-sm">
                                        <div className="flex justify-between">
                                            <span className="text-gray-300">WebRTC:</span>
                                            <span className={connectionStatus === 'connected' ? 'text-green-400' : 'text-red-400'}>
                                                {connectionStatus}
                                            </span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-300">Show Status:</span>
                                            <span className={isLive ? "text-red-400" : "text-gray-400"}>
                                                {isLive ? 'LIVE' : 'Off Air'}
                                            </span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-300">Recording:</span>
                                            <span className={isRecording ? "text-red-400" : "text-gray-400"}>
                                                {isRecording ? 'Recording' : 'Stopped'}
                                            </span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-300">Active Calls:</span>
                                            <span>{activeCallers.length}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-300">Ready Callers:</span>
                                            <span>{callerQueue.length}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-300">Last Sync:</span>
                                            <span>{lastSync || 'Never'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<EnhancedHostDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
